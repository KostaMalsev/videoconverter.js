

<head>
  title>Create Gif</title>
  <meta name="viewport" content="width=device-width,height=device-height,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
  <meta charset="utf-8">

  <link rel="stylesheet" href="styles.css">

</head>

<body>

<div class="dialog">


    <div class="subtitle" id='log'> </div>

    <div class="subtitle">Upload image file</div>

    <input type='file'/> <br> 
    <img id="myImg" src="#">
    
    <div class="subtitle">Upload video file</div>

    <input type="file" accept="video/*" id="input-tag"/>
    <hr>
    
    <figure id="videoContainer">
      <video controls id="video-tag">
        <source id="video-source" src="splashVideo">
        Your browser does not support the video tag.
      </video>
    </figure>
    

    <div class="button" id="run">Convert</div>
    <br> </br>
    <div id="files"></div>

<script>



var worker;
var sampleImageData=null;
var sampleVideoData=null;
var outputElement;
var filesElement;
var running = false;
var isWorkerLoaded = false;




//Link to html elements:
const videoSrc = document.querySelector("#video-source");
const videoTag = document.querySelector("#video-tag");
const inputTag = document.querySelector("#input-tag");
const log= document.querySelector('#log');  
const vFigure = document.querySelector('#videoContainer');  
  
let button = document.querySelector("#run");


let command = "";



//Check if worker is supported:
var isSupported = (function() {
  return document.querySelector && window.URL && window.Worker;
})();



//Check if worker is ready to run:
function isReady() {
  return !running && isWorkerLoaded;
  //return !running && isWorkerLoaded && sampleImageData && sampleVideoData;
}



//Set the defaults:
vFigure.style.visibility = "hidden";
//vFigure.style.visibility = "visible";	


//Set button defaults:
button.classList.add('gray');
button.classList.add("disabled");



//Image loader:
window.addEventListener('load', async function() {
  
  
  document.querySelector('input[type="file"]').addEventListener('change', async function() {
    
      if (this.files && this.files[0]) {
          var img = document.querySelector('img');
          
          img.onload = () => {
              URL.revokeObjectURL(img.src);  // no longer needed, free memory
          }

          img.src = URL.createObjectURL(this.files[0]); // set src to blob url
          
          //Generate blob from url:
          let blob = await fetch(img.src).then(r => r.blob());

          //Convert image to buffer Array:
          retreiveImage(blob);
          
          //Set to convert gif to video:
          button.classList.remove('gray');
          button.classList.remove("disabled");
          button.removeEventListener('click')

          //Attach run command to convert button
          button.addEventListener('click',convertGifToMp4);
          
      }
  });
  
  
  

inputTag.addEventListener('change',  readVideo);


//Read video from url
function readVideo(event) {
  
    if (event.target.files && event.target.files[0]) {
      var reader = new FileReader();
  
      reader.onload = function(e) {
        videoSrc.src = e.target.result
        videoTag.load();
        
        //sampleVideoData = new Uint8Array(e.target.result);
        
      }.bind(this)
  
      reader.readAsDataURL(event.target.files[0]);
    }
    
    //Set to convert gif to video:
    button.classList.remove('gray');
    button.classList.remove("disabled");
    //Attach run command to convert button
    button.removeEventListener('click')
    button.addEventListener('click',convertVideo2Gif);
  }
  
});


//Push blob to arrayBuffer of image
function retreiveImage(blob) {

  var fileReader = new FileReader();
  
  fileReader.onload = function(event) {
    sampleImageData = new Uint8Array(event.target.result);
  };
  
  fileReader.readAsArrayBuffer(blob);
  
}



//Push blob to arrayBuffer of video
/*function retreiveVideo(blob) {

  var fileReader = new FileReader();
  
  fileReader.onload = function(event) {
    
    sampleVideoData = new Uint8Array(event.target.result);
    
  };
  
  fileReader.readAsArrayBuffer(blob);
  
}*/








function initWorker() {
  
  if(isWorkerLoaded) return;
  
  console.log('Start init worker')
  
  worker = new Worker("worker-asm.js");
  
  button.classList.add("gray");
  button.classList.add("disabled");
  button.innerHTML = 'Loading engine'
  
  filesElement = document.querySelector("#files");

  
  worker.onmessage = function (event) {
      
      const message = event.data;
      
      console.log('Received message:',message.type)
      
      
      if (message.type == "ready") {
        
        console.log('Worker is ready');
        
        button.classList.remove("gray");
        button.classList.remove("disabled");
        button.innerHTML = 'Press to Convert'

        
        isWorkerLoaded = true;
        
        //Run the command:
        runCommand(command);
                
      }
      
      if (message.type == "done") {
      
          //stopRunning();
          console.log('worker has finished')
          
          var buffers = message.data;
          
          button.innerHTML = 'Press to Convert';
                    
          var blob_ = new Blob([buffers[0].data]);
          
          let video_ = document.querySelector('#video-source');
          
          
          //Generate the downloadable link:
          buffers.forEach(function(file) {
            
            filesElement.appendChild(getDownloadLink(file.data, file.name));
            
          });
          
          stopRunning();
      }
      
      if (message.type == "start") 
        console.log("Worker has received command\n");
      
      if (message.type == "stdout") 
        console.log(message.data + "\n");
        log.innerHTML = message.data;
    }

  }


let workerInitPromise=null;

function initFinished(resolve)
{
  if(isWorkerLoaded) resolve();
}




//Convert mp4 264 video to gif:
async function convertGifToMp4()
{
  await runCommand('-i input.gif -vf "crop=trunc(iw/2)*2:trunc(ih/2)*2" -b:v 0 -crf 25 -f mp4 -vcodec libx264 -pix_fmt yuv420p output.mp4');
}

//Convert gif to mp4 264 format video:
async function convertVideo2Gif()
{
  await runCommand('-i input.mp4 -vf "fps=10,scale=320:-1:flags=lanczos" -c:v pam -f image2pipe - | convert -delay 10 - -loop 0 -layers optimize output.gif');
}

//Convert webm video to gif:
async function convertGifToWebm()
{
  await runCommand(''-t 5 -i input.webm -vf showinfo -strict -2 output.gif'');
}


//Run the ffmpeg:
async function runCommand(text) {
  
  command = text;

  //text = '-t 5 -i input.webm -vf showinfo -strict -2 output.gif';
  //text = '-i input.gif -b:v 0 -crf 25 -f mp4 -vcodec libx264 -pix_fmt yuv420p output.mp4'
  //text = '-i input.gif -vf "crop=trunc(iw/2)*2:trunc(ih/2)*2" -b:v 0 -crf 25 -f mp4 -vcodec libx264 -pix_fmt yuv420p output.mp4'

    //Load engine if not yet loaded:    
    initWorker();

    if (isReady()) {

      startRunning();

      var args = parseArguments(text);

      console.log(args);

      worker.postMessage({
        type: "command",
        arguments: args,
        files: [{
            "name": "input.gif",
            "data": sampleImageData
          },
          {
            "name": "input.mp4",
            "data": sampleVideoData
          }
        ]

      });
    }
}


function startRunning() {
  //document.querySelector("#image-loader").style.visibility = "visible";
  //outputElement.className = "";
  //filesElement.innerHTML = "";
  button.innerHTML = 'Conversion in progress';
  running = true;
}



function stopRunning() {
  //document.querySelector("#image-loader").style.visibility = "hidden";
  button.innerHTML = 'Press to Convert';
  running = false;
}






function parseArguments(text) {
  
  text = text.replace(/\s+/g, ' ');
  var args = [];
  // Allow double quotes to not split args.
  text.split('"').forEach(function(t, i) {
    t = t.trim();
    if ((i % 2) === 1) {
      args.push(t);
    } else {
      args = args.concat(t.split(" "));
    }
  });
  return args;
}


let tmpBlob=null;

//Generate downloadable link
function getDownloadLink(fileData, fileName) {

  if (fileName.match(/\.jpeg|\.gif|\.jpg|\.png/)) {

    var blob = new Blob([fileData]);
    var src = window.URL.createObjectURL(blob);
    var img = document.createElement('img');

    img.src = src;
    return img;
    
  } else {

      var a = document.createElement('a');

      a.classList.add('button');

      a.download = fileName;
      var blob = new Blob([fileData]);
      var src = window.URL.createObjectURL(blob);
      a.href = src;
      a.textContent = 'Download ' + fileName + "!";
      return a;
  }
}




  


  
  
  



/*
document.addEventListener("DOMContentLoaded", function() {

  //initWorker();
  //retrieveSampleVideo();
  //retrieveSampleImage();

  var inputElement = document.querySelector("#input");
  outputElement = document.querySelector("#output");
  filesElement = document.querySelector("#files");

  inputElement.addEventListener("keydown", function(e) {
    if (e.keyCode === 13) {
      //runCommand(inputElement.value);
    }
  }, false);
  document.querySelector("#run").addEventListener("click", function() {
    //runCommand(inputElement.value);
  });

  [].forEach.call(document.querySelectorAll(".sample"), function(link) {
    link.addEventListener("click", function(e) {
      inputElement.value = this.getAttribute("data-command");
      //runCommand(inputElement.value);
      e.preventDefault();
    });
  });

});
*/

/*
function retrieveSampleImage() {
  var oReq = new XMLHttpRequest();
  oReq.open("GET", "bigbuckbunny.jpg", true);
  oReq.responseType = "arraybuffer";

  oReq.onload = function (oEvent) {
    var arrayBuffer = oReq.response;
    if (arrayBuffer) {
      sampleImageData = new Uint8Array(arrayBuffer);
    }
  };

  oReq.send(null);
}
*/

/*
function retrieveSampleVideo() {
  var oReq = new XMLHttpRequest();
  oReq.open("GET", "bigbuckbunny.webm", true);
  oReq.responseType = "arraybuffer";

  oReq.onload = function (oEvent) {
    var arrayBuffer = oReq.response;
    if (arrayBuffer) {
      sampleVideoData = new Uint8Array(arrayBuffer);
    }
  };

  oReq.send(null);
}
*/
</script>
</body>
