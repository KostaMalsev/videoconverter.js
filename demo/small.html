

<head>
  title>Create Gif</title>
  <meta name="viewport" content="width=device-width,height=device-height,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
  <meta charset="utf-8">

  <link rel="stylesheet" href="styles.css">

</head>

<body>

<div class="dialog">

    
    <div class="title">Upload image file</div>
    
    <div class="subtitle" id='log'> </div>

    <input type='file'/> <br> 
    <img id="myImg" src="#">
    
    <div class="title">Upload video file</div>

    <input type="file" accept="video/*" id="input-tag"/>
    <hr>
    
    <video controls id="video-tag">
      <source id="video-source" src="splashVideo">
      Your browser does not support the video tag.
    </video>
    

    <div class="button" id="run">Convert</div>
    <br> </br><br> </br>
    <div id="files"></div>

<script>



var worker;
var sampleImageData;
var sampleVideoData;
var outputElement;
var filesElement;
var running = false;
var isWorkerLoaded = false;



//Link to html elements:
const videoSrc = document.querySelector("#video-source");
const videoTag = document.querySelector("#video-tag");
const inputTag = document.querySelector("#input-tag");
const log= document.querySelector('#log');  
  
  
let button = document.querySelector(".button");

var isSupported = (function() {
  return document.querySelector && window.URL && window.Worker;
})();




function isReady() {
  return !running;
  //return !running && isWorkerLoaded && sampleImageData && sampleVideoData;
}



document.querySelector('#run').addEventListener('click',runCommand)



//Image loader:
window.addEventListener('load', async function() {
  
  
  document.querySelector('input[type="file"]').addEventListener('change', async function() {
    
      if (this.files && this.files[0]) {
          var img = document.querySelector('img');
          
          img.onload = () => {
              URL.revokeObjectURL(img.src);  // no longer needed, free memory
          }

          img.src = URL.createObjectURL(this.files[0]); // set src to blob url
          
          //Generate blob from url:
          let blob = await fetch(img.src).then(r => r.blob());

          //Convert image to buffer Array:
          retreiveImage(blob);
          
      }
  });
  
  
  
  inputTag.addEventListener('change',  readVideo);



//Read video from url
function readVideo(event) {
  
    if (event.target.files && event.target.files[0]) {
      var reader = new FileReader();
  
      reader.onload = function(e) {
        videoSrc.src = e.target.result
        videoTag.load();
        
        sampleVideoData = new Uint8Array(e.target.result);
        
      }.bind(this)
  
      reader.readAsDataURL(event.target.files[0]);
    }
  }
  
});


//Push blob to arrayBuffer of image
function retreiveImage(blob) {

  var fileReader = new FileReader();
  
  fileReader.onload = function(event) {
    sampleImageData = new Uint8Array(event.target.result);
  };
  
  fileReader.readAsArrayBuffer(blob);
  
}



//Push blob to arrayBuffer of video
/*function retreiveVideo(blob) {

  var fileReader = new FileReader();
  
  fileReader.onload = function(event) {
    
    sampleVideoData = new Uint8Array(event.target.result);
    
  };
  
  fileReader.readAsArrayBuffer(blob);
  
}*/








function initWorker() {
  
  
  worker = new Worker("worker-asm.js");
  
  button.classList.add("gray");
  button.classList.add("disabled");
  button.innerHTML = 'Loading engine'
  
  filesElement = document.querySelector("#files");

  
  
  worker.onmessage = function (event) {
      
      const message = event.data;
      
      console.log('Received message:',message.type)
      
      
      if (message.type == "ready") {
        
        console.log('Worker is ready');
        
        button.classList.remove("gray");
        button.classList.remove("disabled");
        button.innerHTML = 'Press to Convert'

        
        isWorkerLoaded = true;
        
        //Create a mutex wait on load: 
         workerInitPromise = new Promise(resolve => {
              if(isWorkerLoaded){ console.log('promise resolved'); resolve();}
          });
                
      }
      
      if (message.type == "done") {
      
          //stopRunning();
          console.log('worker has finished')
          
          var buffers = message.data;
          
          button.innerHTML = 'Press to Convert';
                    
          var blob_ = new Blob([buffers[0].data]);
          
          let video_ = document.querySelector('#video-source');
          console.log(video_)
          
          
          //Generate the downloadable link:
          buffers.forEach(function(file) {
            
            filesElement.appendChild(getDownloadLink(file.data, file.name));
            
          });
          
          stopRunning();
      }
      
      if (message.type == "start") 
        console.log("Worker has received command\n");
      
      if (message.type == "stdout") 
        console.log(message.data + "\n");
        log.innerHTML = message.data;
    }

  }


let workerInitPromise=null;


async function runCommand(text) {

  //text = '-t 5 -i input.webm -vf showinfo -strict -2 output.gif';
  //text = '-i input.gif -b:v 0 -crf 25 -f mp4 -vcodec libx264 -pix_fmt yuv420p output.mp4'
  text = '-i input.gif -vf "crop=trunc(iw/2)*2:trunc(ih/2)*2" -b:v 0 -crf 25 -f mp4 -vcodec libx264 -pix_fmt yuv420p output.mp4'

  if (workerInitPromise) {    

    initWorker();
    await workerInitPromise;
    

    if (isReady()) {

      startRunning();

      var args = parseArguments(text);

      console.log(args);

      worker.postMessage({
        type: "command",
        arguments: args,
        files: [{
            "name": "input.gif",
            "data": sampleImageData
          },
          {
            "name": "input.webm",
            "data": sampleVideoData
          }
        ]

      });
    }
  }
}


function startRunning() {
  //document.querySelector("#image-loader").style.visibility = "visible";
  //outputElement.className = "";
  //filesElement.innerHTML = "";
  button.innerHTML = 'Conversion in progress';
  running = true;
}



function stopRunning() {
  //document.querySelector("#image-loader").style.visibility = "hidden";
  button.innerHTML = 'Press to Convert';
  running = false;
}






function parseArguments(text) {
  
  text = text.replace(/\s+/g, ' ');
  var args = [];
  // Allow double quotes to not split args.
  text.split('"').forEach(function(t, i) {
    t = t.trim();
    if ((i % 2) === 1) {
      args.push(t);
    } else {
      args = args.concat(t.split(" "));
    }
  });
  return args;
}


let tmpBlob=null;

//Generate downloadable link
function getDownloadLink(fileData, fileName) {

  if (fileName.match(/\.jpeg|\.gif|\.jpg|\.png/)) {

    var blob = new Blob([fileData]);
    var src = window.URL.createObjectURL(blob);
    var img = document.createElement('img');

    img.src = src;
    return img;
    
  } else {

      var a = document.createElement('a');

      a.classList.add('button');

      a.download = fileName;
      var blob = new Blob([fileData]);
      var src = window.URL.createObjectURL(blob);
      a.href = src;
      a.textContent = 'Download ' + fileName + "!";
      return a;
  }
}




  


  
  
  



/*
document.addEventListener("DOMContentLoaded", function() {

  //initWorker();
  //retrieveSampleVideo();
  //retrieveSampleImage();

  var inputElement = document.querySelector("#input");
  outputElement = document.querySelector("#output");
  filesElement = document.querySelector("#files");

  inputElement.addEventListener("keydown", function(e) {
    if (e.keyCode === 13) {
      //runCommand(inputElement.value);
    }
  }, false);
  document.querySelector("#run").addEventListener("click", function() {
    //runCommand(inputElement.value);
  });

  [].forEach.call(document.querySelectorAll(".sample"), function(link) {
    link.addEventListener("click", function(e) {
      inputElement.value = this.getAttribute("data-command");
      //runCommand(inputElement.value);
      e.preventDefault();
    });
  });

});
*/

/*
function retrieveSampleImage() {
  var oReq = new XMLHttpRequest();
  oReq.open("GET", "bigbuckbunny.jpg", true);
  oReq.responseType = "arraybuffer";

  oReq.onload = function (oEvent) {
    var arrayBuffer = oReq.response;
    if (arrayBuffer) {
      sampleImageData = new Uint8Array(arrayBuffer);
    }
  };

  oReq.send(null);
}
*/

/*
function retrieveSampleVideo() {
  var oReq = new XMLHttpRequest();
  oReq.open("GET", "bigbuckbunny.webm", true);
  oReq.responseType = "arraybuffer";

  oReq.onload = function (oEvent) {
    var arrayBuffer = oReq.response;
    if (arrayBuffer) {
      sampleVideoData = new Uint8Array(arrayBuffer);
    }
  };

  oReq.send(null);
}
*/
</script>
</body>
